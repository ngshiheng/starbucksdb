name: Scrape latest data

on:
    push:
    workflow_dispatch:
    schedule:
        - cron: "0 0 * * 0" # Every Sunday at 00:00

env:
    PYTHON_VERSION: "3.11"
    POETRY_VERSION: "1.7"
    POETRY_URL: https://install.python-poetry.org

jobs:
    crawl-and-update:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install poetry & datasette
              run: |
                  pipx install poetry==${{ env.POETRY_VERSION }}
                  pipx install datasette

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: poetry
                  cache-dependency-path: poetry.lock

            - name: Set poetry environment
              run: |
                  poetry env use ${{ env.PYTHON_VERSION }}

            - name: Install dependencies
              run: |
                  poetry install --no-root

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                  name: starbucks.db
                  path: ./data/
              continue-on-error: true

            - name: Restore scrapy cache
              id: scrapy-cache-restore
              uses: actions/cache/restore@v4
              with:
                  path: |
                      .scrapy
                  key: ${{ runner.os }}-pypoetry-${{ hashFiles('**/poetry.lock') }}

            - name: Check if scrapy cache is restored
              if: steps.scrapy-cache-restore.outputs.cache-hit == 'true'
              run: |
                  echo "Scrapy cache restored"

            - name: Run scrapy crawl
              run: poetry run scrapy crawl singapore

            - name: Save scrapy cache
              id: cache-primes-save
              uses: actions/cache/save@v4
              with:
                  path: |
                      .scrapy
                  key: ${{ steps.scrapy-cache-restore.outputs.cache-primary-key }}

            - name: Upload updated artifact
              uses: actions/upload-artifact@v4
              with:
                  name: starbucks.db
                  path: ./data/
                  if-no-files-found: error

            - name: Deploy to vercel
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              run: |-
                  ls data/
                  echo $VERCEL_TOKEN
                  datasette install datasette-publish-vercel
                  datasette publish vercel data/starbucks.db \
                      --project=starbucksdb
                      --install=datasette-hashed-urls
                      --install=datasette-cluster-map
                      --token="$VERCEL_TOKEN"
                      --setting allow_download off 
                      --setting allow_csv_stream off 
                      --setting max_csv_mb 0
                      --extra-options "-i"
